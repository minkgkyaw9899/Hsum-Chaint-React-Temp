name: PR Tests

on:
  workflow_run:
    workflows: ["PR Title Check"]
    types: [completed]

jobs:
  tests:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Check out code at PR commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - uses: oven-sh/setup-bun@v1

      - name: Install dependencies
        run: bun install

      - name: Run tests
        run: bun run test:ci

  notify-test-failure:
    needs: tests
    if: failure()
    uses: ./.github/workflows/reusable-telegram.yml
    secrets: inherit
    with:
      message: |
        <b>ðŸ”” Tests Failed</b>

        <b>Project:</b> NextJS
        <b>Actor:</b> ${{ github.actor }}
        <b>Title:</b> ${{ github.event.workflow_run.pull_requests[0].title }}
        <b>Branch:</b> `${{ github.event.workflow_run.pull_requests[0].head.ref }}` â†’ `${{ github.event.workflow_run.pull_requests[0].base.ref }}`
